services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-netden}
      - POSTGRES_USER=${POSTGRES_USER:-netden}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-netdenpass}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-netden} -d ${POSTGRES_DB:-netden}"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 5s
    volumes:
      - postgres_data:/var/lib/postgresql/data

  app:
    build:
      context: .
      args:
        NEXT_PUBLIC_BUILD_SHA: ${NEXT_PUBLIC_BUILD_SHA:-dev}
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:3000/api/health"]
      interval: 20s
      timeout: 8s
      retries: 10
      start_period: 60s
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL:-postgresql://netden:netdenpass@postgres:5432/netden?schema=public}
      - NETDEN_SESSION_SECRET=${NETDEN_SESSION_SECRET:-local-session-secret-change-me-32chars}
      - NEXT_PUBLIC_BUILD_SHA=${NEXT_PUBLIC_BUILD_SHA:-dev}
      - CADDY_ADMIN_URL=${CADDY_ADMIN_URL:-http://proxy:2019}

  proxy:
    image: caddy:2.10-alpine
    restart: unless-stopped
    command: ["sh", "/etc/caddy/run.sh"]
    depends_on:
      app:
        condition: service_healthy
    ports:
      - "${PROXY_PORT:-8080}:80"
      - "${PROXY_HTTPS_PORT:-8443}:443"
    volumes:
      - ./docker/proxy/bootstrap.json:/etc/caddy/bootstrap.json:ro
      - ./docker/proxy/run.sh:/etc/caddy/run.sh:ro
      - caddy_data:/data
      - caddy_config:/config
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1/healthz"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 10s

volumes:
  postgres_data:
  caddy_data:
  caddy_config:
