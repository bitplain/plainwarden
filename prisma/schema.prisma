generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

enum EventType {
  event
  task
}

enum EventStatus {
  pending
  done
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  passwordHash String
  createdAt    DateTime @default(now())
  events       Event[]
  eventSeries  EventSeries[]
  notes        Note[]
}

model Event {
  id                  String       @id @default(uuid())
  userId              String
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title               String
  description         String
  date                String
  time                String?
  type                EventType
  status              EventStatus  @default(pending)
  categoryId          String?
  recurrenceSeriesId  String?
  recurrenceSeries    EventSeries? @relation(fields: [recurrenceSeriesId], references: [id], onDelete: SetNull)
  recurrenceException Boolean      @default(false)
  revision            Int          @default(0)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@index([userId, date, time])
  @@index([userId, recurrenceSeriesId, date])
}

model EventSeries {
  id                  String      @id @default(uuid())
  userId              String
  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  title               String
  description         String
  time                String?
  type                EventType
  status              EventStatus @default(pending)
  startDate           String
  recurrenceFrequency String
  recurrenceInterval  Int
  recurrenceCount     Int?
  recurrenceUntil     String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  events              Event[]

  @@index([userId, startDate])
}

model IntegrationConfig {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Note {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title      String
  body       String    @default("")
  parentId   String?
  parent     Note?     @relation("NoteHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children   Note[]    @relation("NoteHierarchy")
  tags       String[]  @default([])
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  versions   NoteVersion[]
  outLinks   NoteLink[]     @relation("NoteLinkSource")
  inLinks    NoteLink[]     @relation("NoteLinkTarget")
  eventLinks NoteEventLink[]

  @@index([userId])
  @@index([userId, parentId])
}

model NoteVersion {
  id        String   @id @default(uuid())
  noteId    String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  title     String
  body      String
  createdAt DateTime @default(now())

  @@index([noteId])
}

model NoteLink {
  id       String @id @default(uuid())
  sourceId String
  source   Note   @relation("NoteLinkSource", fields: [sourceId], references: [id], onDelete: Cascade)
  targetId String
  target   Note   @relation("NoteLinkTarget", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId])
  @@index([targetId])
}

model NoteEventLink {
  id      String @id @default(uuid())
  noteId  String
  note    Note   @relation(fields: [noteId], references: [id], onDelete: Cascade)
  eventId String

  @@unique([noteId, eventId])
  @@index([noteId])
}
