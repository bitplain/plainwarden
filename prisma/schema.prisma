generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

enum EventType {
  event
  task
}

enum EventStatus {
  pending
  done
}

enum AgentReminderKind {
  due_today
  due_tomorrow
  overdue
}

enum AgentReminderChannel {
  in_app
  push
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  name           String
  passwordHash   String
  createdAt      DateTime        @default(now())
  events         Event[]
  eventSeries    EventSeries[]
  notes          Note[]
  kanbanBoards   KanbanBoard[]
  kanbanCards    KanbanCard[]
  kanbanComments KanbanComment[]
  kanbanWorklogs KanbanWorklog[]
  pushSubscriptions PushSubscription[]
  agentReminders AgentReminder[]
}

model Event {
  id                  String       @id @default(uuid())
  userId              String
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title               String
  description         String
  date                String
  time                String?
  type                EventType
  status              EventStatus  @default(pending)
  categoryId          String?
  recurrenceSeriesId  String?
  recurrenceSeries    EventSeries? @relation(fields: [recurrenceSeriesId], references: [id], onDelete: SetNull)
  recurrenceException Boolean      @default(false)
  revision            Int          @default(0)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@index([userId, date, time])
  @@index([userId, recurrenceSeriesId, date])
}

model EventSeries {
  id                  String      @id @default(uuid())
  userId              String
  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  title               String
  description         String
  time                String?
  type                EventType
  status              EventStatus @default(pending)
  startDate           String
  recurrenceFrequency String
  recurrenceInterval  Int
  recurrenceCount     Int?
  recurrenceUntil     String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  events              Event[]

  @@index([userId, startDate])
}

model IntegrationConfig {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Note {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title      String
  body       String    @default("")
  parentId   String?
  parent     Note?     @relation("NoteHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children   Note[]    @relation("NoteHierarchy")
  tags       String[]  @default([])
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  versions   NoteVersion[]
  outLinks   NoteLink[]     @relation("NoteLinkSource")
  inLinks    NoteLink[]     @relation("NoteLinkTarget")
  eventLinks NoteEventLink[]

  @@index([userId])
  @@index([userId, parentId])
}

model NoteVersion {
  id        String   @id @default(uuid())
  noteId    String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  title     String
  body      String
  createdAt DateTime @default(now())

  @@index([noteId])
}

model NoteLink {
  id       String @id @default(uuid())
  sourceId String
  source   Note   @relation("NoteLinkSource", fields: [sourceId], references: [id], onDelete: Cascade)
  targetId String
  target   Note   @relation("NoteLinkTarget", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([sourceId, targetId])
  @@index([targetId])
}

model NoteEventLink {
  id      String @id @default(uuid())
  noteId  String
  note    Note   @relation(fields: [noteId], references: [id], onDelete: Cascade)
  eventId String

  @@unique([noteId, eventId])
  @@index([noteId])
}

model KanbanBoard {
  id        String         @id @default(uuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  columns   KanbanColumn[]
  cards     KanbanCard[]

  @@index([userId])
}

model KanbanColumn {
  id        String       @id @default(uuid())
  boardId   String
  board     KanbanBoard  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  title     String
  position  Int
  wipLimit  Int?
  isDone    Boolean      @default(false)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  cards     KanbanCard[]

  @@index([boardId])
}

model KanbanCard {
  id           String               @id @default(uuid())
  boardId      String
  board        KanbanBoard          @relation(fields: [boardId], references: [id], onDelete: Cascade)
  columnId     String
  column       KanbanColumn         @relation(fields: [columnId], references: [id], onDelete: Cascade)
  userId       String
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  title        String
  description  String               @default("")
  position     Int
  dueDate      String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  checklists   KanbanChecklist[]
  comments     KanbanComment[]
  worklogs     KanbanWorklog[]
  dependencies KanbanDependency[]   @relation("KanbanCardDeps")
  dependents   KanbanDependency[]   @relation("KanbanCardBlocks")
  eventLinks   KanbanCardEventLink[]

  @@index([boardId])
  @@index([columnId])
  @@index([userId])
}

model KanbanChecklist {
  id        String                @id @default(uuid())
  cardId    String
  card      KanbanCard            @relation(fields: [cardId], references: [id], onDelete: Cascade)
  title     String
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  items     KanbanChecklistItem[]

  @@index([cardId])
}

model KanbanChecklistItem {
  id          String          @id @default(uuid())
  checklistId String
  checklist   KanbanChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  text        String
  completed   Boolean         @default(false)
  position    Int
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([checklistId])
}

model KanbanComment {
  id        String     @id @default(uuid())
  cardId    String
  card      KanbanCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  body      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([cardId])
  @@index([userId])
}

model KanbanWorklog {
  id              String     @id @default(uuid())
  cardId          String
  card            KanbanCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  startedAt       DateTime
  endedAt         DateTime?
  durationSeconds Int?
  note            String     @default("")
  createdAt       DateTime   @default(now())

  @@index([cardId])
  @@index([userId])
}

model KanbanDependency {
  id          String     @id @default(uuid())
  cardId      String
  card        KanbanCard @relation("KanbanCardDeps", fields: [cardId], references: [id], onDelete: Cascade)
  dependsOnId String
  dependsOn   KanbanCard @relation("KanbanCardBlocks", fields: [dependsOnId], references: [id], onDelete: Cascade)

  @@unique([cardId, dependsOnId])
  @@index([dependsOnId])
}

model KanbanCardEventLink {
  id      String     @id @default(uuid())
  cardId  String
  card    KanbanCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  eventId String

  @@unique([cardId, eventId])
  @@index([cardId])
}

model PushSubscription {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint       String
  p256dh         String
  auth           String
  expirationTime DateTime?
  userAgent      String?
  failureCount   Int      @default(0)
  lastSuccessAt  DateTime?
  lastFailureAt  DateTime?
  disabledAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, endpoint])
  @@index([userId, disabledAt])
}

model AgentReminder {
  id          String               @id @default(uuid())
  userId      String
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceType  String
  sourceId    String
  title       String
  body        String
  kind        AgentReminderKind
  channel     AgentReminderChannel @default(in_app)
  severity    Int                  @default(1)
  dueDate     String?
  navigateTo  String?
  dedupeBucket String
  dedupeKey   String               @unique
  pushedAt    DateTime?
  readAt      DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([userId, readAt, createdAt])
  @@index([userId, pushedAt, createdAt])
  @@index([userId, sourceType, sourceId])
}
